{"id":"kicad-edit-mcp-4bn","title":"fix: lib_symbols emptied on save","description":"kicad-sch-api v0.5.6 has two bugs that combine to empty lib_symbols on save:\n\n1. LibraryParser._parse_lib_symbols() always returns {} — discards parsed data\n2. Schematic._sync_components_to_data() rebuilds lib_symbols from symbol cache that returns None (no KiCad libs installed)\n\nWorkaround in kicad_helpers.py:\n- Add _extract_lib_symbols(path) helper: re-reads .kicad_sch with sexpdata, extracts raw lib_symbols entries as dict {name: raw_sexp_list}\n- Before every sch.save(), inject preserved lib_symbols into sch._data['lib_symbols'] — serializer already handles raw sexp lists\n- Update test fixtures with actual lib_symbols content\n- Add test_lib_symbols_preserved_after_update() round-trip test\n\nKey files:\n- kicad_helpers.py: all 3 save callsites (update_component:313, update_schematic_info:388, rename_net:442)\n- tests/test_helpers.py: new test\n- tests/fixtures/test_schematic.kicad_sch: add lib_symbols content\n- tests/fixtures/test_schematic_v9.kicad_sch: add lib_symbols content\n\nRoot cause evidence: library_parser.py:24-27, schematic.py:1668-1681","status":"closed","priority":2,"issue_type":"task","owner":"simon@aster.wien","created_at":"2026-02-19T06:49:43.159083088+01:00","created_by":"Simon Aster","updated_at":"2026-02-19T07:32:33.47758327+01:00","closed_at":"2026-02-19T07:32:33.47758327+01:00","close_reason":"Closed","comments":[{"id":38,"issue_id":"kicad-edit-mcp-4bn","author":"Simon Aster","text":"INVESTIGATION: Root cause fully traced.\n\nParsing path: parser.py:321 -\u003e library_parser.py:24-27 (_parse_lib_symbols always returns {})\nSave path: schematic.py:1668-1681 (rebuilds from empty cache) -\u003e parser.py:358-359 -\u003e library_parser.py:31-45 (iterates empty dict)\n\nFix: Add _extract_lib_symbols() to kicad_helpers.py that re-parses file with sexpdata to preserve raw lib_symbols. Inject before every sch.save().\n\nTest fixtures both have empty (lib_symbols) on line 9 — update with real content to catch regressions.","created_at":"2026-02-19T05:49:51Z"},{"id":39,"issue_id":"kicad-edit-mcp-4bn","author":"Simon Aster","text":"LEARNED: _sync_components_to_data() runs inside save() and always overwrites _data['lib_symbols'] at line 1681 of schematic.py. Setting _data['lib_symbols'] before save() is useless. Fix: monkey-patch the instance method so the restore happens after the original sync runs but before FileIOManager writes the file.","created_at":"2026-02-19T06:10:50Z"},{"id":40,"issue_id":"kicad-edit-mcp-4bn","author":"Simon Aster","text":"Completed: added _extract_lib_symbols/_save_with_lib_symbols helpers, patched all 3 save callsites, updated fixtures with real Device:R/C/IC symbols, added 3 regression tests. 38/38 pass.","created_at":"2026-02-19T06:10:54Z"},{"id":41,"issue_id":"kicad-edit-mcp-4bn","author":"Simon Aster","text":"DISPATCH_PROMPT [python-backend-supervisor]:\n\nBEAD_ID: kicad-edit-mcp-4bn\n\n## Task: Fix lib_symbols emptied on save\n\n### Problem\nkicad-sch-api v0.5.6 has two bugs that empty `lib_symbols` on save:\n1. `LibraryParser._parse_lib_symbols()` always returns `{}` (library_parser.py:24-27)\n2. `Schematic._sync_components_to_data()` rebuilds lib_symbols from empty symbol cache (schematic.py:1668-1681)\n\n### Fix (in kicad_helpers.py)\n\n**1. Add `_extract_lib_symbols(path)` helper:**\n- Re-reads the `.kicad_sch` file with `sexpdata.loads()`\n- Finds the `lib_symbols` section in the parsed S-expression tree\n- Extracts each child `(symbol \"Name\" ...)` entry\n- Returns a dict: `{\"Device:R\": [Symbol(\"symbol\"), \"Device:R\", ...], ...}`\n\nThe key insight: `_lib_symbols_to_sexp()` in library_parser.py:36-39 already handles raw sexp lists:\n```python\nif isinstance(symbol_def, list):\n    sexp.append(symbol_def)  # Raw S-expression data - use directly\n```\n\n**2. Create `_save_with_lib_symbols(sch, path)` wrapper:**\n- Calls `_extract_lib_symbols(path)` to get the original lib_symbols\n- Sets `sch._data[\"lib_symbols\"] = preserved_lib_symbols`\n- Calls `sch.save()`\n- Use this wrapper in ALL 3 save callsites:\n  - `update_component()` line 313\n  - `update_schematic_info()` line ~388\n  - `rename_net()` line ~442\n\n**3. Update test fixtures** (`tests/fixtures/test_schematic.kicad_sch` and `tests/fixtures/test_schematic_v9.kicad_sch`):\n\nReplace `(lib_symbols)` (empty) with actual symbol definitions. Use minimal but valid entries for Device:R, Device:C, Device:IC. Example for KiCad 6 format (test_schematic.kicad_sch):\n\n```\n(lib_symbols\n    (symbol \"Device:R\"\n      (pin_numbers hide)\n      (pin_names (offset 0))\n      (exclude_from_sim no)\n      (in_bom yes)\n      (on_board yes)\n      (property \"Reference\" \"R\" (at 2.032 0 90)\n        (effects (font (size 1.27 1.27)))\n      )\n      (property \"Value\" \"R\" (at 0 0 90)\n        (effects (font (size 1.27 1.27)))\n      )\n      (property \"Footprint\" \"\" (at -1.778 0 90)\n        (effects (font (size 1.27 1.27)) hide)\n      )\n      (property \"Datasheet\" \"~\" (at 0","created_at":"2026-02-19T06:11:05Z"},{"id":42,"issue_id":"kicad-edit-mcp-4bn","author":"Simon Aster","text":"Completed: added try/finally to restore monkey-patch in _save_with_lib_symbols, added test_kicad9_lib_symbols_preserved_after_update. 39/39 pass.","created_at":"2026-02-19T06:22:57Z"},{"id":43,"issue_id":"kicad-edit-mcp-4bn","author":"Simon Aster","text":"DISPATCH_PROMPT [python-backend-supervisor]:\n\nBEAD_ID: kicad-edit-mcp-4bn\n\n## Task: Fix code review issues\n\nWorking directory: /home/simon/Nextcloud/Aster/Agents/MCP/dev/kicad-edit-mcp/.worktrees/bd-kicad-edit-mcp-4bn\n\n### Issue 1: Clean up monkey-patch after save\n\nIn `kicad_helpers.py`, `_save_with_lib_symbols()` permanently replaces `_sync_components_to_data` on the instance. Restore it after save using try/finally:\n\n```python\ndef _save_with_lib_symbols(sch: Any, path: Path) -\u003e None:\n    preserved = _extract_lib_symbols(path)\n    original_sync = None\n    if preserved:\n        original_sync = sch._sync_components_to_data\n\n        def _patched_sync() -\u003e None:\n            original_sync()\n            sch._data[\"lib_symbols\"] = preserved\n\n        sch._sync_components_to_data = _patched_sync  # type: ignore[method-assign]\n    try:\n        sch.save()\n    finally:\n        if original_sync is not None:\n            sch._sync_components_to_data = original_sync\n```\n\n### Issue 2: Add v9 lib_symbols regression test\n\nIn `tests/test_helpers.py`, add a test using the `sch_v9` fixture:\n\n```python\ndef test_kicad9_lib_symbols_preserved_after_update(sch_v9: Path) -\u003e None:\n    \"\"\"KiCad 9: lib_symbols must survive round-trip through update_component.\"\"\"\n    kicad_helpers.update_component(str(sch_v9), \"R1\", {\"Value\": \"4k7\"})\n    saved = sch_v9.read_text()\n    assert '(symbol \"Device:R\"' in saved\n    assert '(symbol \"Device:C\"' in saved\n    assert '(symbol \"Device:IC\"' in saved\n```\n\n### Verify\nRun: `cd /home/simon/Nextcloud/Aster/Agents/MCP/dev/kicad-edit-mcp/.worktrees/bd-kicad-edit-mcp-4bn \u0026\u0026 venv/bin/python -m pytest tests/test_helpers.py -v`\n\nAll tests must pass (should be 39 now). Amend the previous commit.","created_at":"2026-02-19T06:23:01Z"},{"id":44,"issue_id":"kicad-edit-mcp-4bn","author":"Simon Aster","text":"LEARNED: kicad-sch-api v0.5.6 LibraryParser._parse_lib_symbols() always returns {} and _sync_components_to_data() rebuilds from empty cache. Workaround: re-read raw sexp from file before save, monkey-patch _sync_components_to_data to restore preserved data. Clean up patch with try/finally.","created_at":"2026-02-19T06:23:15Z"}]}
{"id":"kicad-edit-mcp-5ee","title":"Push to GitHub","description":"Push to simon-77/kicad-edit-mcp. Update MCP README with new server entry.","status":"closed","priority":2,"issue_type":"task","owner":"simon@aster.wien","created_at":"2026-02-17T17:16:36.27667043+01:00","created_by":"Simon Aster","updated_at":"2026-02-17T18:30:19.450474721+01:00","closed_at":"2026-02-17T18:30:19.450474721+01:00","close_reason":"Closed","dependencies":[{"issue_id":"kicad-edit-mcp-5ee","depends_on_id":"kicad-edit-mcp-bbo","type":"blocks","created_at":"2026-02-17T17:16:36.279667816+01:00","created_by":"Simon Aster"}]}
{"id":"kicad-edit-mcp-64r","title":"Sexp Surgery Engine: replace kicad-sch-api","description":"Complete rewrite per SEXP_SURGERY_SPEC.md. Replace kicad-sch-api with surgical s-expression editing. Zero data loss by design.","status":"closed","priority":2,"issue_type":"epic","owner":"simon@aster.wien","created_at":"2026-02-19T10:28:47.545556419+01:00","created_by":"Simon Aster","updated_at":"2026-02-19T11:58:05.259337388+01:00","closed_at":"2026-02-19T11:58:05.259337388+01:00","close_reason":"Closed"}
{"id":"kicad-edit-mcp-64r.1","title":"Phase 1: sexp_surgery.py core engine + unit tests","description":"Create sexp_surgery.py with SexpSpan, SexpDocument, byte-span tracking, query API, surgical replace/insert/delete, save. Plus tests/test_sexp_surgery.py.","status":"closed","priority":2,"issue_type":"task","owner":"simon@aster.wien","created_at":"2026-02-19T10:28:52.96441979+01:00","created_by":"Simon Aster","updated_at":"2026-02-19T10:37:53.374138029+01:00","closed_at":"2026-02-19T10:37:53.374138029+01:00","close_reason":"Closed","dependencies":[{"issue_id":"kicad-edit-mcp-64r.1","depends_on_id":"kicad-edit-mcp-64r","type":"parent-child","created_at":"2026-02-19T10:28:52.965730998+01:00","created_by":"Simon Aster"}],"comments":[{"id":45,"issue_id":"kicad-edit-mcp-64r.1","author":"Simon Aster","text":"Completed: sexp_surgery.py + tests/test_sexp_surgery.py. 40/40 tests pass on both KiCad 6 and 9 fixtures.","created_at":"2026-02-19T09:34:13Z"}]}
{"id":"kicad-edit-mcp-64r.2","title":"Phase 2: Rewrite kicad_helpers.py using SexpDocument","description":"Replace kicad-sch-api with SexpDocument. Rewrite list_components, get_component, update_component, update_schematic_info, rename_net. Remove all workaround functions.","status":"closed","priority":2,"issue_type":"task","owner":"simon@aster.wien","created_at":"2026-02-19T10:28:55.134048576+01:00","created_by":"Simon Aster","updated_at":"2026-02-19T11:58:05.091674257+01:00","closed_at":"2026-02-19T11:58:05.091674257+01:00","close_reason":"Closed","dependencies":[{"issue_id":"kicad-edit-mcp-64r.2","depends_on_id":"kicad-edit-mcp-64r","type":"parent-child","created_at":"2026-02-19T10:28:55.135699427+01:00","created_by":"Simon Aster"},{"issue_id":"kicad-edit-mcp-64r.2","depends_on_id":"kicad-edit-mcp-64r.1","type":"blocks","created_at":"2026-02-19T10:29:04.214245376+01:00","created_by":"Simon Aster"}],"comments":[{"id":46,"issue_id":"kicad-edit-mcp-64r.2","author":"Simon Aster","text":"DISPATCH_PROMPT [python-backend-supervisor]:\n\nBEAD_ID: kicad-edit-mcp-64r.2\nEPIC_ID: kicad-edit-mcp-64r\n\nTASK: Rewrite kicad_helpers.py to use SexpDocument instead of kicad-sch-api. Also update tests/test_helpers.py to remove kicad-sch-api verification.\n\nWORKING DIRECTORY: /home/simon/Nextcloud/Aster/Agents/dev/kicad-edit-mcp/.worktrees/bd-kicad-edit-mcp-64r.1\n(worktree already exists with sexp_surgery.py committed and passing 40 tests)\n\nThe venv is at ../../venv/ (relative to worktree). Run tests with:\n```\n../../venv/bin/python -m pytest tests/test_helpers.py -v\n```\n\n## WHAT TO DO\n\nRewrite kicad_helpers.py completely. The NEW version:\n\n1. **Imports**: Replace `from kicad_sch_api import Schematic` with `from sexp_surgery import SexpDocument`. Keep sexpdata import for Symbol type checks.\n\n2. **REMOVE** these workaround functions entirely:\n   - `_is_hidden_in_sexp()`\n   - `_sync_hidden_properties()`\n   - `_set_property_hidden()`\n   - `_extract_lib_symbols()`\n   - `_save_with_lib_symbols()`\n\n3. **REWRITE** these 5 functions using SexpDocument:\n\n### list_components(schematic_path, filter=None) -\u003e list[dict]\nLoad with SexpDocument. Find all symbols that have `lib_id` child (schematic instances, not lib_symbols). For each, get Reference, Value, Footprint properties. Return list of dicts.\n\n### get_component(schematic_path, reference) -\u003e dict\nLoad with SexpDocument. Find symbol by reference. Walk its children, find all `property` nodes. For each, extract name (child[1]), value (child[2]), and visibility (using doc.is_property_hidden()). Return dict mapping name -\u003e {\"value\": ..., \"visible\": ...}.\n\n### update_component(schematic_path, reference, properties) -\u003e str\nThe most complex. For each property in the input dict:\n- **value is None** → delete the property (doc.delete_span)\n- **property exists** → surgically replace the value string using doc.get_property_value_span() + doc.replace_bytes()\n- **property doesn't exist** → insert new property before symbol's closing paren using doc.insert_before_end()\n- **visibility control** → if input has {\"value\": ..., \"vis","created_at":"2026-02-19T09:38:28Z"},{"id":47,"issue_id":"kicad-edit-mcp-64r.2","author":"Simon Aster","text":"Completed: rewrote kicad_helpers.py using SexpDocument, removed all kicad-sch-api workarounds, added global_label support. Updated 3 test assertions to use raw text checks. All 79 tests pass.","created_at":"2026-02-19T09:46:39Z"}]}
{"id":"kicad-edit-mcp-64r.3","title":"Phase 3: Test fixtures + preservation tests","description":"Download KiCad demo fixtures (IO.kicad_sch, pic_programmer.kicad_sch). Port test_helpers.py. Add round-trip diff tests and preservation tests for mirror/dnp/global_label/justify/fields_autoplaced.","status":"closed","priority":2,"issue_type":"task","owner":"simon@aster.wien","created_at":"2026-02-19T10:28:57.594591253+01:00","created_by":"Simon Aster","updated_at":"2026-02-19T10:45:39.201478971+01:00","closed_at":"2026-02-19T10:45:39.201478971+01:00","close_reason":"Closed","dependencies":[{"issue_id":"kicad-edit-mcp-64r.3","depends_on_id":"kicad-edit-mcp-64r","type":"parent-child","created_at":"2026-02-19T10:28:57.596197338+01:00","created_by":"Simon Aster"},{"issue_id":"kicad-edit-mcp-64r.3","depends_on_id":"kicad-edit-mcp-64r.2","type":"blocks","created_at":"2026-02-19T10:29:04.300210608+01:00","created_by":"Simon Aster"}]}
{"id":"kicad-edit-mcp-64r.4","title":"Phase 4: Cleanup deps, Dockerfile, merge to main","description":"Remove kicad-sch-api from pyproject.toml. Update Dockerfile. Remove SEXP_SURGERY_SPEC.md. Clean stale branches. Merge to main. Verify Docker build.","status":"closed","priority":2,"issue_type":"task","owner":"simon@aster.wien","created_at":"2026-02-19T10:28:59.455068262+01:00","created_by":"Simon Aster","updated_at":"2026-02-19T11:58:05.175744313+01:00","closed_at":"2026-02-19T11:58:05.175744313+01:00","close_reason":"Closed","dependencies":[{"issue_id":"kicad-edit-mcp-64r.4","depends_on_id":"kicad-edit-mcp-64r","type":"parent-child","created_at":"2026-02-19T10:28:59.456984895+01:00","created_by":"Simon Aster"},{"issue_id":"kicad-edit-mcp-64r.4","depends_on_id":"kicad-edit-mcp-64r.3","type":"blocks","created_at":"2026-02-19T10:29:04.38423485+01:00","created_by":"Simon Aster"}]}
{"id":"kicad-edit-mcp-7ji","title":"Fix: property visibility not preserved when editing components","description":"When update_component adds new properties, they're created as bare Property(key, value) with effects=None. KiCad interprets missing effects as visible. Fix: (1) new properties default hide=True for non-Reference/Value, (2) support explicit {value, visible} dict in properties param, (3) enrich get_component to return visibility info. See plan: .claude/plans/radiant-squishing-comet.md. Files: kicad_helpers.py, tests/fixtures/test_schematic.kicad_sch, tests/test_helpers.py","status":"closed","priority":2,"issue_type":"task","owner":"simon@aster.wien","created_at":"2026-02-18T09:05:01.429875115+01:00","created_by":"Simon Aster","updated_at":"2026-02-18T10:44:49.084097419+01:00","closed_at":"2026-02-18T10:44:49.084097419+01:00","close_reason":"Closed","comments":[{"id":26,"issue_id":"kicad-edit-mcp-7ji","author":"Simon Aster","text":"INVESTIGATION: Root cause at kicad_helpers.py:165 - Property(key=key, value=str(value)) creates bare property with effects=None. kiutils serializes this without (effects ...) block, which KiCad interprets as visible. In-place updates (line 158-162) are safe - only .value mutated, effects preserved. Secondary: get_component (line 85) flattens to {name: value}, discarding visibility. Fix plan in .claude/plans/radiant-squishing-comet.md","created_at":"2026-02-18T08:05:18Z"},{"id":27,"issue_id":"kicad-edit-mcp-7ji","author":"Simon Aster","text":"DISPATCH_PROMPT [python-backend-supervisor]:\n\nBEAD_ID: kicad-edit-mcp-7ji\n\n## Task: Fix property visibility not preserved when editing components\n\n### Bug\nWhen `update_component()` adds new properties, they're created as bare `Property(key=key, value=str(value))` with `effects=None` at `kicad_helpers.py:165`. kiutils serializes this without an `(effects ...)` block, which KiCad interprets as \"visible with default font.\" This makes all new properties visible instead of hidden.\n\nThe in-place update path (line 158-162) is safe - it only modifies `.value`, preserving effects.\n\n### Required Changes\n\n**File: `kicad_helpers.py`**\n\n1. **Add imports** (line 12): Add `Effects, Font` to the existing import:\n   ```python\n   from kiutils.items.common import Effects, Font, Property, TitleBlock\n   ```\n\n2. **Fix `update_component()` property loop** (lines 139-167):\n   - Support two value formats: plain `{\"Value\": \"100nF\"}` and rich `{\"Voltage\": {\"value\": \"3.3V\", \"visible\": false}}`\n   - Normalize at loop start: if value is a dict with \"value\" key, extract `raw_value` and `explicit_visible`; otherwise plain value with `explicit_visible=None`\n   - For existing properties: preserve visibility, but if `explicit_visible` is not None AND `existing.effects` exists, set `existing.effects.hide = not explicit_visible`\n   - For new properties: create with `Effects(font=Font(height=1.27, width=1.27), hide=...)` where hide defaults to `True` for non-Reference/Value properties (KiCad convention), overridden by `explicit_visible` if provided\n   - Copy position from first existing property as anchor point\n\n3. **Enrich `get_component()` return** (lines 84-87): Change from `{name: value}` to `{name: {\"value\": value, \"visible\": bool}}`:\n   ```python\n   props = {}\n   for p in sym.properties:\n       hidden = p.effects.hide if p.effects else False\n       props[p.key] = {\"value\": p.value, \"visible\": not hidden}\n   ```\n\n**File: `tests/fixtures/test_schematic.kicad_sch`**\n\n4. Add realistic effects blocks to match real KiCad files. For each symbol's Footprint and Datasheet properties, add:\n   ```\n  ","created_at":"2026-02-18T08:09:45Z"},{"id":28,"issue_id":"kicad-edit-mcp-7ji","author":"Simon Aster","text":"DISPATCH_PROMPT [python-backend-supervisor]:\n\nBEAD_ID: kicad-edit-mcp-7ji\n\nOne review finding to fix: when creating a new property (line 202 in kicad_helpers.py), copy the position from the first existing property on the component so the new property text appears near the component instead of at absolute (0,0).\n\nIn the worktree at `.worktrees/bd-kicad-edit-mcp-7ji/`, in `kicad_helpers.py`, right after creating `new_prop` at line 202 and before `target.properties.append(new_prop)`, add:\n\n```python\n# Anchor new property near the component (avoid default 0,0 origin)\nif target.properties:\n    new_prop.position = target.properties[0].position\n```\n\nThis copies the Position object from the first existing property (e.g., Reference) so the new property text is at least near the component on the schematic sheet.\n\nThen run `pytest tests/` to verify all tests still pass and commit.","created_at":"2026-02-18T08:32:13Z"},{"id":29,"issue_id":"kicad-edit-mcp-7ji","author":"Simon Aster","text":"DISPATCH_PROMPT [python-backend-supervisor]:\n\nBEAD_ID: kicad-edit-mcp-7ji\n\nSmall fix in worktree `.worktrees/bd-kicad-edit-mcp-7ji/kicad_helpers.py`:\n\nCurrently new properties copy position from the first existing property. Instead, use the **symbol's own position** (the component origin) via `target.position`.\n\nFind the line that does:\n```python\nif target.properties:\n    new_prop.position = target.properties[0].position\n```\n\nReplace with:\n```python\nnew_prop.position = target.position\n```\n\nThis is simpler and semantically correct — `target` is the `SchematicSymbol` and `target.position` is the component's placement coordinate on the schematic.\n\nRun `pytest tests/` to verify, then amend into the previous commit (since this is a refinement of the same change).","created_at":"2026-02-18T08:33:53Z"},{"id":30,"issue_id":"kicad-edit-mcp-7ji","author":"Simon Aster","text":"DISPATCH_PROMPT [python-backend-supervisor]:\n\nBEAD_ID: kicad-edit-mcp-7ji\n\nCode review found issues to fix in the worktree at `.worktrees/bd-kicad-edit-mcp-7ji/`. Address all in one commit.\n\n## Code Fixes\n\n### Fix 1: Validate malformed rich dict input (`kicad_helpers.py`)\n\nIn `update_component()`, the normalization block (around line 179) silently converts a dict without \"value\" key to its string repr. Add validation:\n\n```python\nif isinstance(value, dict) and \"value\" not in value:\n    raise ValueError(\n        f\"Property '{key}': dict value must have a 'value' key, \"\n        f\"e.g. {{'value': '3.3V', 'visible': false}}\"\n    )\n```\n\nPlace this BEFORE the existing `if isinstance(value, dict) and \"value\" in value:` check.\n\n### Fix 2: Deepcopy position to avoid reference sharing (`kicad_helpers.py`)\n\nThe line `new_prop.position = target.position` assigns a reference. If someone later mutates the property's position, it could affect the symbol. Change to:\n\n```python\nfrom copy import deepcopy\n# ... in the new property creation block:\nnew_prop.position = deepcopy(target.position)\n```\n\nAdd `from copy import deepcopy` at the top of the file with the other imports.\n\n### Fix 3: Add test for malformed dict input (`tests/test_helpers.py`)\n\nAdd a test that verifies `update_component` raises `ValueError` when given a dict without \"value\" key:\n\n```python\ndef test_update_component_rejects_malformed_dict(tmp_path):\n    sch = tmp_path / \"test.kicad_sch\"\n    shutil.copy(FIXTURE, sch)\n    with pytest.raises(ValueError, match=\"must have a 'value' key\"):\n        update_component(str(sch), \"R1\", {\"Voltage\": {\"foo\": \"bar\"}})\n```\n\n## Documentation Updates\n\n### Fix 4: `kicad_helpers.py` — `get_component` docstring\n\nUpdate the Returns section to describe the new format:\n\n```\nReturns:\n    Dict mapping property name to a dict with ``value`` and ``visible``\n    keys, e.g. ``{\"Reference\": {\"value\": \"C5\", \"visible\": True},\n    \"Footprint\": {\"value\": \"...\", \"visible\": False}}``.\n```\n\n### Fix 5: `kicad_helpers.py` — `update_component` docstring\n\nAdd to the docstring description of the prop","created_at":"2026-02-18T08:46:01Z"}]}
{"id":"kicad-edit-mcp-a5n","title":"fix: update_net_class KiCad 9 compat","description":"update_net_class writes minimal JSON — KiCad 9 silently drops classes missing required fields. Three issues: (1) new classes need all 16 default fields copied from Default class, (2) net patterns should go in netclass_patterns[] not nets inside class dict, (3) _save_project strips trailing newline. See plan: .claude/plans/federated-exploring-oasis.md","status":"closed","priority":2,"issue_type":"task","owner":"simon@aster.wien","created_at":"2026-02-19T11:35:29.995421042+01:00","created_by":"Simon Aster","updated_at":"2026-02-19T11:52:18.089126855+01:00","closed_at":"2026-02-19T11:52:18.089126855+01:00","close_reason":"Closed","comments":[{"id":48,"issue_id":"kicad-edit-mcp-a5n","author":"Simon Aster","text":"INVESTIGATION: Root cause at kicad_helpers.py:698-701 — new classes get only {name, nets:[]}. Missing 14 fields KiCad 9 requires. Pattern handling at :712-718 writes to class.nets instead of net_settings.netclass_patterns[]. _save_project at :618-620 omits trailing newline.","created_at":"2026-02-19T10:37:02Z"},{"id":49,"issue_id":"kicad-edit-mcp-a5n","author":"Simon Aster","text":"DISPATCH_PROMPT [python-backend-supervisor]:\n\nBEAD_ID: kicad-edit-mcp-a5n\n\n## Task\n\nFix `update_net_class` so KiCad 9 recognizes created net classes. Work in the worktree at `/home/simon/Nextcloud/Aster/Agents/dev/kicad-edit-mcp/.worktrees/bd-kicad-edit-mcp-a5n/`.\n\n## Root Cause (3 bugs)\n\n1. **Missing default fields** — New classes get only `{\"name\": ..., \"nets\": []}`. KiCad 9 needs all 16 fields (bus_width, clearance, diff_pair_gap, diff_pair_via_gap, diff_pair_width, line_style, microvia_diameter, microvia_drill, pcb_color, priority, schematic_color, track_width, via_diameter, via_drill, wire_width + name).\n2. **Wrong pattern location** — Patterns stored as `\"nets\"` inside class dict. KiCad 9 reads from `net_settings.netclass_patterns[]` with format `{\"netclass\": \"ClassName\", \"pattern\": \"/Net\"}`.\n3. **Trailing newline stripped** — `_save_project()` uses `json.dumps()` without trailing `\\n`. KiCad project files end with `\\n`.\n\n## Implementation Plan\n\nAll edits in the worktree: `/home/simon/Nextcloud/Aster/Agents/dev/kicad-edit-mcp/.worktrees/bd-kicad-edit-mcp-a5n/`\n\n### 1. `kicad_helpers.py` ~line 590: Add `_NETCLASS_DEFAULTS` constant\n\n```python\n_NETCLASS_DEFAULTS: dict[str, Any] = {\n    \"bus_width\": 12,\n    \"clearance\": 0.2,\n    \"diff_pair_gap\": 0.25,\n    \"diff_pair_via_gap\": 0.25,\n    \"diff_pair_width\": 0.2,\n    \"line_style\": 0,\n    \"microvia_diameter\": 0.3,\n    \"microvia_drill\": 0.1,\n    \"pcb_color\": \"rgba(0, 0, 0, 0.000)\",\n    \"priority\": 2147483647,\n    \"schematic_color\": \"rgba(0, 0, 0, 0.000)\",\n    \"track_width\": 0.2,\n    \"via_diameter\": 0.6,\n    \"via_drill\": 0.3,\n    \"wire_width\": 6,\n}\n```\n\nAlso update `_NETCLASS_FIELD_MAP` to include all fields from `_NETCLASS_DEFAULTS` (add bus_width, diff_pair_via_gap, line_style, pcb_color, priority, schematic_color, wire_width).\n\n### 2. `kicad_helpers.py` line 618-620: Fix `_save_project()`\n\nAppend `\\n` after `json.dumps()`:\n```python\ndef _save_project(data: dict, path: Path) -\u003e None:\n    path.write_text(json.dumps(data, indent=2) + \"\\n\", encoding=\"utf-8\")\n```\n\n### 3. `kicad_helpers.py` line 623-658: Fix ","created_at":"2026-02-19T10:44:24Z"}]}
{"id":"kicad-edit-mcp-bbo","title":"Integration test","description":"Register in .mcp.json. Test: all tools visible default config, disable tools via restrictive config verify disappear, update_component on sample .kicad_sch, update_net_class on sample .kicad_pro","status":"closed","priority":2,"issue_type":"task","owner":"simon@aster.wien","created_at":"2026-02-17T17:16:32.489544176+01:00","created_by":"Simon Aster","updated_at":"2026-02-17T18:24:53.723497358+01:00","closed_at":"2026-02-17T18:24:53.723497358+01:00","close_reason":"Closed","dependencies":[{"issue_id":"kicad-edit-mcp-bbo","depends_on_id":"kicad-edit-mcp-w22","type":"blocks","created_at":"2026-02-17T17:16:32.492597257+01:00","created_by":"Simon Aster"}],"comments":[{"id":20,"issue_id":"kicad-edit-mcp-bbo","author":"Simon Aster","text":"INVESTIGATION: server.py smoke tested OK — import works, --help works, 7/7 tools enabled. No real .kicad_sch or .kicad_pro files on disk. Test needs to: 1) create minimal sample files using kiutils, 2) test tool enable/disable via config, 3) test actual modifications via kicad_helpers.","created_at":"2026-02-17T17:12:37Z"},{"id":21,"issue_id":"kicad-edit-mcp-bbo","author":"Simon Aster","text":"Completed: 34 tests passing — 25 helper tests (all 7 functions) + 9 server config tests. Fixtures: hand-crafted .kicad_sch with R1/C1/U1 + SPI1_SCK label, .kicad_pro with Default net class.","created_at":"2026-02-17T17:19:41Z"},{"id":22,"issue_id":"kicad-edit-mcp-bbo","author":"Simon Aster","text":"Completed: 34 integration tests covering all 7 kicad_helpers functions and server config loading, with hand-crafted KiCad fixture files.","created_at":"2026-02-17T17:19:56Z"},{"id":23,"issue_id":"kicad-edit-mcp-bbo","author":"Simon Aster","text":"Completed: 34 integration tests covering all 7 kicad_helpers functions and server config loading, with hand-crafted KiCad fixture files.","created_at":"2026-02-17T17:21:05Z"},{"id":24,"issue_id":"kicad-edit-mcp-bbo","author":"Simon Aster","text":"Completed: 34 integration tests covering all 7 kicad_helpers functions and server config loading, with hand-crafted KiCad fixture files.","created_at":"2026-02-17T17:22:25Z"},{"id":25,"issue_id":"kicad-edit-mcp-bbo","author":"Simon Aster","text":"DISPATCH_PROMPT [python-backend-supervisor]:\n\nBEAD_ID: kicad-edit-mcp-bbo\n\nIntegration tests for kicad-edit-mcp. Work in worktree:\n/home/simon/Nextcloud/Aster/Agents/MCP/dev/kicad-edit-mcp/.worktrees/bd-kicad-edit-mcp-jqq/\n\nVenv: ./venv/bin/python (fastmcp 2.14.5, kiutils 1.4.8, pyyaml 6.0.3)\n\n## Context\n\nserver.py and kicad_helpers.py are implemented. No real KiCad files exist on disk — you must create minimal test fixtures.\n\n## Tasks\n\n### 1. Create test fixtures in `tests/fixtures/`\n\n**Minimal .kicad_sch** — use kiutils to generate programmatically in a test helper, or create a minimal valid file by hand. Must contain:\n- At least 3 components: R1 (10k resistor), C1 (100nF cap), U1 (generic IC)\n- At least 1 net label (e.g., \"SPI1_SCK\")\n- A title block with some metadata\n\n**Minimal .kicad_pro** — valid JSON with:\n- `net_settings.classes` containing at least a \"Default\" class with track_width, clearance, via_diameter\n\n### 2. Create `tests/test_helpers.py` — pytest tests for kicad_helpers.py\n\nTest each of the 7 functions:\n- `list_components` — returns all 3, filter \"C\" returns only C1\n- `get_component` — \"R1\" returns correct props, \"MISSING\" raises ValueError\n- `update_component` — set value, remove property, set dnp flag, verify file changed\n- `update_schematic_info` — set title and revision, verify\n- `rename_net` — rename \"SPI1_SCK\" to \"SPI_CLK\", verify count and file\n- `list_net_classes` — returns Default class with rules\n- `update_net_class` — create new class \"USB\", add pattern, verify\n\nUse tmp_path fixture to copy test fixtures before modifying them.\n\n### 3. Create `tests/test_server.py` — test config loading and tool registration\n\n- Test that default config enables all 7 tools\n- Test that restrictive config (disable some tools) results in fewer registered tools\n- Test unknown tool name in config triggers warning\n\n### 4. Install pytest in venv and run tests\n\n```bash\n./venv/bin/pip install pytest\n./venv/bin/pytest tests/ -v\n```\n\nAll tests must pass.\n\n### 5. Commit\n\n```\ntest: add integration tests for helpers and server config\n```\nU","created_at":"2026-02-17T17:23:36Z"}]}
{"id":"kicad-edit-mcp-bm4","title":"Implement kicad_helpers.py","description":"All 7 functions, pure Python, no MCP dep. list_components, get_component, update_component, update_schematic_info, rename_net, list_net_classes, update_net_class. Signatures at kicad-dev/kicad-mcp-thoughts.md:70-108. Use kiutils.","status":"closed","priority":2,"issue_type":"task","owner":"simon@aster.wien","created_at":"2026-02-17T17:16:17.495107702+01:00","created_by":"Simon Aster","updated_at":"2026-02-17T17:30:51.500724966+01:00","closed_at":"2026-02-17T17:30:51.500724966+01:00","close_reason":"Closed","dependencies":[{"issue_id":"kicad-edit-mcp-bm4","depends_on_id":"kicad-edit-mcp-jqq","type":"blocks","created_at":"2026-02-17T17:16:17.498346023+01:00","created_by":"Simon Aster"}],"comments":[{"id":7,"issue_id":"kicad-edit-mcp-bm4","author":"Simon Aster","text":"INVESTIGATION: Tool signatures at kicad-dev/kicad-mcp-thoughts.md:70-108. 7 funcs using kiutils: list_components(path,filter), get_component(path,ref), update_component(path,ref,properties), update_schematic_info(path,title,rev,date,author,company), rename_net(path,old,new), list_net_classes(path), update_net_class(path,name,rules,add_pattern). Worktree at .worktrees/bd-kicad-edit-mcp-jqq/ has venv with kiutils 1.4.8 installed.","created_at":"2026-02-17T16:27:12Z"},{"id":9,"issue_id":"kicad-edit-mcp-bm4","author":"Simon Aster","text":"DISPATCH_PROMPT [python-backend-supervisor]:\n\nBEAD_ID: kicad-edit-mcp-bm4\n\nImplement kicad_helpers.py — all 7 pure Python functions using kiutils. Work in the worktree at:\n/home/simon/Nextcloud/Aster/Agents/MCP/dev/kicad-edit-mcp/.worktrees/bd-kicad-edit-mcp-jqq/\n\nUse the venv at that same worktree: ./venv/bin/python (kiutils 1.4.8, pyyaml 6.0.3 already installed).\n\nFile to edit: `kicad_helpers.py` (currently placeholder).\n\n## 7 Functions to Implement\n\n### Schematic functions (.kicad_sch via kiutils.schematic.Schematic)\n\n1. **list_components(schematic_path: str, filter: str = None) -\u003e list**\n   Returns: [{\"reference\": \"C5\", \"value\": \"100nF\", \"footprint\": \"...\"}, ...]\n   Filter: optional prefix, e.g. \"C\" for capacitors, \"R\" for resistors\n   Use: `Schematic.from_file()`, iterate `schematic.schematicSymbols`\n\n2. **get_component(schematic_path: str, reference: str) -\u003e dict**\n   Returns: all properties as dict {\"Reference\": \"C5\", \"Value\": \"100nF\", ...}\n   Use: find symbol by reference in schematicSymbols, extract all properties\n\n3. **update_component(schematic_path: str, reference: str, properties: dict) -\u003e str**\n   properties: {\"Value\": \"100nF\"} to set, {\"Voltage\": None} to remove, {\"dnp\": True} for DNP flag\n   Returns: success message describing changes\n   Use: find symbol, modify properties, schematic.to_file()\n\n4. **update_schematic_info(schematic_path: str, title=None, revision=None, date=None, author=None, company=None) -\u003e str**\n   Modify title block metadata\n   Returns: success message with updated fields\n   Use: schematic.titleBlock\n\n5. **rename_net(schematic_path: str, old_name: str, new_name: str) -\u003e str**\n   Find and replace net labels\n   Returns: success message with count of renamed labels\n   Use: iterate schematic looking for net labels matching old_name\n\n### Project functions (.kicad_pro)\n\n6. **list_net_classes(project_path: str) -\u003e list**\n   Returns: [{\"name\": \"Default\", \"track_width\": 0.2, \"clearance\": 0.15, \"via_diameter\": 0.6, \"patterns\": [...], ...}, ...]\n   Note: .kicad_pro is JSON. Net classes live under net_settings.classes or similar.\n  ","created_at":"2026-02-17T16:27:38Z"},{"id":12,"issue_id":"kicad-edit-mcp-bm4","author":"Simon Aster","text":"Completed: 7 functions implemented. Schematic functions use kiutils (Schematic.from_file/to_file, schematicSymbols, labels, globalLabels, hierarchicalLabels, titleBlock). Project functions use json.load/dump directly since kiutils has no .kicad_pro support. All error paths raise ValueError with clear messages.","created_at":"2026-02-17T16:30:27Z"}]}
{"id":"kicad-edit-mcp-jqq","title":"Project scaffolding","description":"pyproject.toml (fastmcp, kiutils, pyyaml), .gitignore (venv/, __pycache__/), create venv, install deps","status":"closed","priority":2,"issue_type":"task","owner":"simon@aster.wien","created_at":"2026-02-17T17:16:11.479761473+01:00","created_by":"Simon Aster","updated_at":"2026-02-17T17:26:54.896845285+01:00","closed_at":"2026-02-17T17:26:54.896845285+01:00","close_reason":"Closed","comments":[{"id":1,"issue_id":"kicad-edit-mcp-jqq","author":"Simon Aster","text":"INVESTIGATION: Reference pattern from digikey-mcp. pyproject.toml uses PEP 621 [project] format with flat deps list. FastMCP pattern: mcp = FastMCP('name'), @mcp.tool() decorator, mcp.run() entry. For kicad-edit-mcp: deps are fastmcp, kiutils, pyyaml. Python \u003e=3.11. Venv at ./venv/.","created_at":"2026-02-17T16:18:11Z"},{"id":2,"issue_id":"kicad-edit-mcp-jqq","author":"Simon Aster","text":"Completed: pyproject.toml (PEP 621), .gitignore, server.py, kicad_helpers.py placeholders; venv created with fastmcp 2.14.5, kiutils 1.4.8, pyyaml 6.0.3","created_at":"2026-02-17T16:21:09Z"},{"id":3,"issue_id":"kicad-edit-mcp-jqq","author":"Simon Aster","text":"Completed: pyproject.toml (PEP 621), .gitignore, server.py and kicad_helpers.py placeholders; venv with fastmcp 2.14.5, kiutils 1.4.8, pyyaml 6.0.3","created_at":"2026-02-17T16:21:19Z"},{"id":4,"issue_id":"kicad-edit-mcp-jqq","author":"Simon Aster","text":"Completed: pyproject.toml, .gitignore, server.py, kicad_helpers.py scaffolded; venv with fastmcp/kiutils/pyyaml installed","created_at":"2026-02-17T16:21:24Z"},{"id":5,"issue_id":"kicad-edit-mcp-jqq","author":"Simon Aster","text":"Completed: pyproject.toml, .gitignore, server.py, kicad_helpers.py scaffolded; venv with fastmcp/kiutils/pyyaml installed","created_at":"2026-02-17T16:24:24Z"},{"id":6,"issue_id":"kicad-edit-mcp-jqq","author":"Simon Aster","text":"DISPATCH_PROMPT [python-backend-supervisor]:\n\nBEAD_ID: kicad-edit-mcp-jqq\n\nProject scaffolding for kicad-edit-mcp. Working dir: /home/simon/Nextcloud/Aster/Agents/MCP/dev/kicad-edit-mcp\n\nTasks:\n1. Create `pyproject.toml` using PEP 621 [project] format (like digikey-mcp pattern):\n   - name: kicad-edit-mcp\n   - version: 0.1.0\n   - description: \"KiCad schematic/project modification MCP server\"\n   - requires-python: \"\u003e=3.11\"\n   - dependencies: [\"fastmcp\", \"kiutils\", \"pyyaml\"]\n\n2. Create `.gitignore` with: venv/, __pycache__/, *.pyc, .env, *.egg-info/, dist/, build/, .claude-tools/\n\n3. Create venv and install deps:\n   ```\n   python3 -m venv venv\n   ./venv/bin/pip install fastmcp kiutils pyyaml\n   ```\n\n4. Create empty placeholder files so the structure is clear:\n   - `server.py` with just a comment: `# kicad-edit-mcp server — implementation in BD-002/BD-003`\n   - `kicad_helpers.py` with just a comment: `# kiutils helper functions — implementation in BD-002`\n\nDo NOT create config.yaml or README.md (those are BD-004).\n\nAfter completing, commit all files (not venv/) with message:\n```\nfeat: project scaffolding with pyproject.toml and venv\n```\nUse git author: simon-77 \u003csimon-77@users.noreply.github.com\u003e","created_at":"2026-02-17T16:25:57Z"}]}
{"id":"kicad-edit-mcp-sf5","title":"Dockerize kicad-edit-mcp with env-var tool config","description":"Replace config.yaml tool lockdown with DISABLED_TOOLS env var. Add Dockerfile. Drop pyyaml dependency. Update tests and README. See plan: ~/.claude/plans/dapper-kindling-comet.md","status":"closed","priority":2,"issue_type":"task","owner":"simon@aster.wien","created_at":"2026-02-18T11:28:33.492685704+01:00","created_by":"Simon Aster","updated_at":"2026-02-18T11:49:28.622305752+01:00","closed_at":"2026-02-18T11:49:28.622305752+01:00","close_reason":"Closed","comments":[{"id":31,"issue_id":"kicad-edit-mcp-sf5","author":"Simon Aster","text":"INVESTIGATION: Pure Python server, 3 deps (fastmcp, kiutils, pyyaml). Config via config.yaml:_load_config() at server.py:33-63. Tool registration conditional at server.py:112-261. Tests at tests/test_server.py cover config loading. Plan: drop pyyaml+config.yaml, use DISABLED_TOOLS env var, add Dockerfile in-repo. Full plan at ~/.claude/plans/dapper-kindling-comet.md","created_at":"2026-02-18T10:29:09Z"},{"id":32,"issue_id":"kicad-edit-mcp-sf5","author":"Simon Aster","text":"Completed: replaced config.yaml/_load_config/_parse_args with DISABLED_TOOLS env var, deleted config.yaml, removed pyyaml from pyproject.toml, added Dockerfile, rewrote test_server.py with importlib.reload pattern, updated README. All 39 tests pass.","created_at":"2026-02-18T10:34:05Z"},{"id":33,"issue_id":"kicad-edit-mcp-sf5","author":"Simon Aster","text":"DISPATCH_PROMPT [python-backend-supervisor]:\n\nBEAD_ID: kicad-edit-mcp-sf5\n\nYou are working in worktree: /home/simon/Nextcloud/Aster/Agents/MCP/dev/kicad-edit-mcp/.worktrees/bd-kicad-edit-mcp-sf5\n\nImplement the plan from /home/simon/.claude/plans/dapper-kindling-comet.md\n\nSummary of changes needed:\n\n## 1. Refactor `server.py` config loading (lines 1-95)\n- Remove `_load_config()` function (lines 33-63)\n- Remove `_parse_args()` function (lines 66-78)\n- Remove `import yaml`, `import argparse`\n- Add `import os`\n- Replace config loading with env var parsing:\n  ```python\n  _raw = os.environ.get(\"DISABLED_TOOLS\", \"\")\n  _disabled = set(t.strip() for t in _raw.split(\",\") if t.strip())\n  # warn on unknown tools\n  _unknown = _disabled - _KNOWN_TOOLS\n  for name in sorted(_unknown):\n      print(f\"Warning: unknown tool '{name}' in DISABLED_TOOLS (ignored)\", file=sys.stderr)\n  _enabled = {name: name not in _disabled for name in _KNOWN_TOOLS}\n  ```\n- Keep startup logging to stderr (enabled/disabled tool lists)\n- Keep ALL conditional tool registration blocks (lines 112-261) unchanged\n- Keep entry point main() unchanged\n\n## 2. Delete `config.yaml`\n\n## 3. Remove `pyyaml` from `pyproject.toml` dependencies\n\n## 4. Create `Dockerfile` (in repo root)\n```dockerfile\nFROM python:3.11-slim\nWORKDIR /app\nCOPY pyproject.toml server.py kicad_helpers.py ./\nRUN pip install --no-cache-dir .\nVOLUME /data\nCMD [\"python\", \"server.py\"]\n```\n\n## 5. Rewrite `tests/test_server.py`\nReplace YAML-based config tests with env var tests:\n- test_default_no_env_enables_all — no env var → all 7 enabled\n- test_disable_single_tool — DISABLED_TOOLS=rename_net → 6 enabled\n- test_disable_multiple_tools — comma-separated → correct count\n- test_unknown_tool_warns — unknown name → stderr warning\n- test_empty_env_enables_all — DISABLED_TOOLS=\"\" → all enabled\n- test_whitespace_handling — \" rename_net , \" → correctly parsed\n- Keep existing test_known_tools_set_has_seven_tools\n\nIMPORTANT: Since _enabled is computed at module import time, tests need to reload the module with monkeypatch on os.enviro","created_at":"2026-02-18T10:34:17Z"}]}
{"id":"kicad-edit-mcp-v7v","title":"Migrate kicad_helpers from kiutils to kicad-sch-api","description":"Replace kiutils with kicad-sch-api to fix KiCad 9 visibility bug. Rewrite 5 schematic functions, remove DNP support, update tests, create KiCad 9 fixture, update pyproject.toml and Dockerfile. Breaking changes acceptable.","status":"closed","priority":2,"issue_type":"task","owner":"simon@aster.wien","created_at":"2026-02-18T13:16:06.767043165+01:00","created_by":"Simon Aster","updated_at":"2026-02-18T13:40:57.894407292+01:00","closed_at":"2026-02-18T13:40:57.894407292+01:00","close_reason":"Closed","comments":[{"id":34,"issue_id":"kicad-edit-mcp-v7v","author":"Simon Aster","text":"INVESTIGATION: Root cause at kiutils Effects.from_sexpr (venv/lib/python3.13/site-packages/kiutils/items/common.py:483) — only handles bare 'hide' token, not KiCad 9's '(hide yes)' boolean. kicad-sch-api v0.5.6 uses format-preserving S-expr manipulation, handles KiCad 9 natively. Plan: /home/simon/.claude/plans/recursive-hugging-castle.md","created_at":"2026-02-18T12:16:11Z"},{"id":35,"issue_id":"kicad-edit-mcp-v7v","author":"Simon Aster","text":"Completed: migrated kicad_helpers.py from kiutils to kicad-sch-api. Key fix: _sync_hidden_properties() reads __sexp_ preserved S-exprs to handle both KiCad 6 bare 'hide' and KiCad 9 '(hide yes)'. All 35 tests pass including 4 new KiCad 9 regression tests.","created_at":"2026-02-18T12:26:53Z"},{"id":36,"issue_id":"kicad-edit-mcp-v7v","author":"Simon Aster","text":"LEARNED: kicad-sch-api parser populates hidden_properties set from __sexp_ preservation but silently drops bare Symbol('hide') KiCad 6 tokens — must call _sync_hidden_properties() after load to fix. Standard properties (Reference, Value, Footprint) have dedicated _data fields (comp._data.value etc) that _symbol_to_sexp reads directly; must update both comp.set_property() AND the dedicated field.","created_at":"2026-02-18T12:26:59Z"},{"id":37,"issue_id":"kicad-edit-mcp-v7v","author":"Simon Aster","text":"DISPATCH_PROMPT [python-backend-supervisor]:\n\nBEAD_ID: kicad-edit-mcp-v7v\n\n## Task: Migrate kicad_helpers.py from kiutils to kicad-sch-api\n\n### Context\n\nKiCad 9 changed `hide` from bare token to `(hide yes)` boolean. kiutils 1.4.8 (unmaintained) silently drops hide state, making ALL properties visible after any update. kicad-sch-api v0.5.6 is format-preserving and handles KiCad 9 natively.\n\n**Breaking changes are acceptable.** The user explicitly approved removing features that don't work.\n\n### Plan file\n\nFull plan at: /home/simon/.claude/plans/recursive-hugging-castle.md — READ IT FIRST.\n\n### Critical files\n\n- `kicad_helpers.py` — main file to rewrite (5 schematic functions)\n- `server.py` — remove `dnp` from update_component docstring\n- `tests/test_helpers.py` — update all tests + add KiCad 9 regression tests\n- `tests/fixtures/test_schematic.kicad_sch` — existing KiCad 6 fixture (keep working)\n- `tests/fixtures/test_schematic_v9.kicad_sch` — NEW KiCad 9 fixture to create\n- `pyproject.toml` — swap `kiutils` → `kicad-sch-api` in deps\n- `Dockerfile` — verify it builds\n\n### kicad-sch-api is already installed\n\nIn `venv/` at the project root. Use `./venv/bin/python` and `./venv/bin/pytest` for testing.\nSource code at: `venv/lib64/python3.13/site-packages/kicad_sch_api/`\n\n### Key API mapping (kiutils → kicad-sch-api)\n\n| Operation | kiutils | kicad-sch-api |\n|-----------|---------|---------------|\n| Load | `Schematic.from_file(path)` | `Schematic.load(path)` |\n| Save | `schematic.to_file()` | `sch.save()` |\n| Components | `schematic.schematicSymbols` (list) | `sch.components` (collection) |\n| Get component | manual list iteration | `sch.components.get(\"R1\")` |\n| Properties | `Property` objects with `.key`, `.value` | `comp.properties` → `Dict[str, str]` |\n| Visibility | `prop.effects.hide` | `comp._symbol.hidden_properties` set |\n| Labels | `schematic.labels`, `.globalLabels`, `.hierarchicalLabels` | `sch.labels`, `sch.hierarchical_labels` (check for global) |\n| Title block | `schematic.titleBlock` object | `sch.title_block` dict |\n\n### Specif","created_at":"2026-02-18T12:27:17Z"}]}
{"id":"kicad-edit-mcp-w22","title":"Implement server.py","description":"FastMCP server. argparse --config, YAML config loading (missing key=enabled), warn unknown keys, conditional mcp.tool() registration, wire to kicad_helpers.py, log enabled/disabled to stderr. Pattern ref: digikey-mcp/digikey_mcp_server.py","status":"closed","priority":2,"issue_type":"task","owner":"simon@aster.wien","created_at":"2026-02-17T17:16:23.304548733+01:00","created_by":"Simon Aster","updated_at":"2026-02-17T18:12:00.700732182+01:00","closed_at":"2026-02-17T18:12:00.700732182+01:00","close_reason":"Closed","dependencies":[{"issue_id":"kicad-edit-mcp-w22","depends_on_id":"kicad-edit-mcp-bm4","type":"blocks","created_at":"2026-02-17T17:16:23.307724035+01:00","created_by":"Simon Aster"}],"comments":[{"id":13,"issue_id":"kicad-edit-mcp-w22","author":"Simon Aster","text":"INVESTIGATION: kicad_helpers.py:1-440 has all 7 functions implemented. config.yaml:1-12 has tool names matching function names exactly. server.py needs: argparse --config, yaml.safe_load config, conditional mcp.tool() registration for each of 7 tools, wiring to kicad_helpers funcs, stderr logging of enabled/disabled. FastMCP pattern: mcp = FastMCP('name'), @mcp.tool() or mcp.tool()(fn), mcp.run().","created_at":"2026-02-17T16:31:08Z"},{"id":14,"issue_id":"kicad-edit-mcp-w22","author":"Simon Aster","text":"Completed: implemented server.py — FastMCP server with argparse --config, YAML opt-out config, conditional tool registration for all 7 tools, stderr startup log, ValueError-\u003eerror-string wrapping","created_at":"2026-02-17T16:32:38Z"},{"id":15,"issue_id":"kicad-edit-mcp-w22","author":"Simon Aster","text":"Completed: implemented server.py — FastMCP server with argparse --config, YAML opt-out config, conditional tool registration for all 7 tools, stderr startup log, ValueError-\u003eerror-string wrapping","created_at":"2026-02-17T16:32:47Z"},{"id":16,"issue_id":"kicad-edit-mcp-w22","author":"Simon Aster","text":"Completed: implemented server.py — FastMCP server with argparse --config, YAML opt-out config, conditional tool registration for all 7 tools, stderr startup log, ValueError-\u003eerror-string wrapping","created_at":"2026-02-17T16:46:07Z"},{"id":17,"issue_id":"kicad-edit-mcp-w22","author":"Simon Aster","text":"Completed: implemented server.py with FastMCP, YAML config, conditional tool registration for all 7 tools","created_at":"2026-02-17T16:47:15Z"},{"id":18,"issue_id":"kicad-edit-mcp-w22","author":"Simon Aster","text":"Completed: server.py implements FastMCP with YAML config and 7 conditional tools","created_at":"2026-02-17T16:48:43Z"},{"id":19,"issue_id":"kicad-edit-mcp-w22","author":"Simon Aster","text":"DISPATCH_PROMPT [python-backend-supervisor]:\n\nBEAD_ID: kicad-edit-mcp-w22\n\nImplement server.py — the FastMCP server for kicad-edit-mcp. Work in worktree:\n/home/simon/Nextcloud/Aster/Agents/MCP/dev/kicad-edit-mcp/.worktrees/bd-kicad-edit-mcp-jqq/\n\nThe venv at ./venv/ has fastmcp 2.14.5, kiutils 1.4.8, pyyaml 6.0.3.\n\n## What Already Exists\n\n- `kicad_helpers.py` — 7 pure Python functions (already implemented, 440 lines)\n- `config.yaml` — default config with all 7 tools enabled\n\n## server.py Requirements\n\n1. **Imports**: fastmcp.FastMCP, argparse, yaml, sys, logging, pathlib, all 7 functions from kicad_helpers\n\n2. **Config loading**:\n   - `argparse` with `--config` flag (optional path)\n   - Default: look for `config.yaml` in same directory as `server.py`\n   - No config file found = all tools enabled (not an error)\n   - `yaml.safe_load()` the config\n   - Warn to stderr if config contains unknown tool names (typo protection)\n   - Missing key in config = tool is enabled (opt-out model)\n\n3. **FastMCP initialization**: `mcp = FastMCP(\"kicad-edit-mcp\")`\n\n4. **Conditional tool registration** — for each of 7 tools, only register if enabled in config:\n   ```python\n   if tool_enabled(\"list_components\"):\n       @mcp.tool()\n       def list_components(schematic_path: str, filter: str = None) -\u003e list:\n           \"\"\"List all components with references, values, footprints. Optional prefix filter (e.g. 'C' for capacitors).\"\"\"\n           return kicad_helpers.list_components(schematic_path, filter)\n   ```\n   \n   The 7 tool names match exactly between config.yaml and kicad_helpers.py:\n   - list_components, get_component, update_component, update_schematic_info, rename_net, list_net_classes, update_net_class\n\n5. **Tool docstrings**: Each registered tool needs a clear, concise docstring (this is what the LLM sees). Keep them short but informative.\n\n6. **Stderr logging on startup**: Log which tools are enabled and disabled:\n   ```\n   kicad-edit-mcp: 5/7 tools enabled\n   kicad-edit-mcp: enabled: list_components, get_component, update_component, list_net_classes, update_net_clas","created_at":"2026-02-17T17:11:47Z"}]}
{"id":"kicad-edit-mcp-wn7","title":"config.yaml + README.md","description":"Default config.yaml with all 7 tools listed + comments. README: purpose, config format, registration examples, tool descriptions.","status":"closed","priority":2,"issue_type":"task","owner":"simon@aster.wien","created_at":"2026-02-17T17:16:28.006892723+01:00","created_by":"Simon Aster","updated_at":"2026-02-17T17:30:51.574996205+01:00","closed_at":"2026-02-17T17:30:51.574996205+01:00","close_reason":"Closed","dependencies":[{"issue_id":"kicad-edit-mcp-wn7","depends_on_id":"kicad-edit-mcp-jqq","type":"blocks","created_at":"2026-02-17T17:16:28.010476858+01:00","created_by":"Simon Aster"}],"comments":[{"id":8,"issue_id":"kicad-edit-mcp-wn7","author":"Simon Aster","text":"INVESTIGATION: config.yaml should list all 7 tools (list_components, get_component, update_component, update_schematic_info, rename_net, list_net_classes, update_net_class) with comments. All enabled by default (opt-out model). README should cover: purpose, YAML config format, Claude Code registration examples, tool descriptions. Pattern ref: kicad-dev/kicad-mcp-thoughts.md for tool descriptions.","created_at":"2026-02-17T16:27:15Z"},{"id":10,"issue_id":"kicad-edit-mcp-wn7","author":"Simon Aster","text":"DISPATCH_PROMPT [python-backend-supervisor]:\n\nBEAD_ID: kicad-edit-mcp-wn7\n\nCreate config.yaml and README.md for kicad-edit-mcp. Work in the worktree at:\n/home/simon/Nextcloud/Aster/Agents/MCP/dev/kicad-edit-mcp/.worktrees/bd-kicad-edit-mcp-jqq/\n\n## config.yaml\n\nDefault config with all tools enabled (opt-out model). Include comments explaining each tool:\n\n```yaml\n# kicad-edit-mcp tool configuration\n# All tools enabled by default. Set to false to disable.\n# Disabled tools are not registered with MCP (LLM cannot see them).\n\ntools:\n  list_components: true      # Read: list components with refs, values, footprints\n  get_component: true        # Read: get all properties of a component by reference\n  update_component: true     # Write: set/remove component properties\n  update_schematic_info: true # Write: modify title block metadata (title, rev, date, author, company)\n  rename_net: true           # Write: rename net labels in schematic\n  list_net_classes: true     # Read: list net class rules and pattern assignments\n  update_net_class: true     # Write: create/modify net class rules and patterns\n```\n\n## README.md\n\nInclude:\n1. **Purpose**: Minimal MCP server for controlled KiCad schematic/project modifications using kiutils. Companion to kicad-analysis (Seeed-Studio, read-only). Property modifications only — no topology changes.\n2. **Tools**: Table of all 7 tools with brief descriptions\n3. **Configuration**: YAML format, --config flag, per-project override example (.kicad-modify.yaml)\n4. **Installation**: pip install deps, Claude Code registration via `claude mcp add`\n5. **Registration examples**: Basic and per-project with --config flag\n6. **Philosophy**: Only modify properties of existing elements. Never change circuit topology or physical layout.\n\nKeep README concise — this is a utility, not a framework.\n\nAfter completing, commit with:\n```\ndocs: add config.yaml and README.md\n```\nUse git author: simon-77 \u003csimon-77@users.noreply.github.com\u003e","created_at":"2026-02-17T16:27:49Z"},{"id":11,"issue_id":"kicad-edit-mcp-wn7","author":"Simon Aster","text":"Completed: config.yaml and README.md written and pushed.","created_at":"2026-02-17T16:28:33Z"}]}
{"id":"kicad-edit-mcp-yey","title":"Test issue: sandbox verification","description":"Testing that bd works correctly","status":"closed","priority":2,"issue_type":"task","owner":"simon@aster.wien","created_at":"2026-02-18T10:50:56.37559522+01:00","created_by":"Simon Aster","updated_at":"2026-02-18T10:51:17.942695874+01:00","closed_at":"2026-02-18T10:51:17.942695874+01:00","close_reason":"Closed"}
